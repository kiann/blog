# 图片和文件互转：原理解释
>简单来说，就是将任意文件的二进制数据流，按照一定的规律转换成图片上的像素，这样就可以按照既定的规则在文件和图片之间来回转换了。

>有了这样的核心基础，我们就能实现很多有意思的东西了。

* 首先能想到的就是文件加密了，在转换的过程中运用对称或者不对称加密算法之后，生成的图片就可以任意传播而只有特定的人能够知道文件内容了。
* 其次，既然任意文件都能够变成图片，那么我们就可以将图床当成网盘来使用了，而且这样的好处是无限容量（在图床支持的情况下），没有限速，甚至有的图床还有cdn加速。不过也有限制，首先图床必须支持原图上传下载，因为每个像素都是数据，那么对图片做任何操作都会损坏原文件。其次是文件大小的限制，大部分图床都会限制单张图片在5M或10M以内，这可以通过将单个文件切割成多片来解决。
* 第三个能想到的就是文件共享。现在各种云盘还有下载工具对于很多资源都会限制或者禁止下载，最常见的就是“根据xxx法规，该文件禁止下载”、“根据版权，blablabla”等等。那么通过将文件转成图片的形式，可以完美的躲过这样的检查，因为对于音视频文件的过滤检查最常见的就是文件名匹配、抽帧识别以及md5匹配，而转换之后的图片都能应对，更何况文件格式都变了，我想不会有哪个软件无聊到对图片做过滤吧。

**然后来大致说一下实现方式，稍后我会把核心代码上传**
比如我们假设使用8位jpeg图来保存一个文件，则每个像素（0xRRGGBB）的每个rgb分量用一个0-255的数来表示，那么每个像素可以保存3个8位的数据，也就是3byte的数据。剩下的问题就简单了，将任意文件按照字节读取后将每个字节转换成0-255的数字，再每三个数字生成一个像素，按照从左往右从上往下的方式依次填充一张图片，最后生成的就是转换（或者说编码）之后的图片了。解码只需要逆向操作即可。

其中涉及到几个问题：
* 第一个就是效率，一个一个像素的操作效率是非常低下的，好在很多语言都提供批量操作像素的方法，java有ImageIO，可以批量读写像素。
* 第二个是大小，文件大小可以任意，但是图片为了配合使用最好还是按照想要上传的位置限制在5-10M内，甚至2-3M内，这样就需要对文件进行切片。而且并不是一个2M的文件正好生成一个2M的图片的，因为图片格式本身的信息也会占用一个大小，所以需要留好余量，比如我使用的图床限制单张图片5M大小，那么在生成的时候我就会限制文件切片大小为4.8M。
* 第三个是长度，因为图片必然是矩形的，但是文件通常并不能刚刚好装满所有像素，这就需要我们想办法在解码时知道有效像素在哪里截至，也就是需要知道一张图片里封装了多大的文件内容。有两种思路，一种是在图片的首或者尾部用几个像素来保存分片文件长度，另一种是在文件外保存，比如编码文件的时候将对应的图片信息和文件分片信息保存在另外的地方，等需要解码的时候再来读取。
* 第四个是格式，通常任意图片格式都可以，但是为了通用，最终选择jpeg，不用png的原因是因为png是有alpha通道的，而我们并不需要。

>其他的脑洞

1、文件共享的方式，将一个文件分片转换成多张图片后，可以上传到一个甚至多个图床，然后将图片信息，图片地址，原文件信息按照一定的格式保存成一个种子文件。我们只需要将这个种子文件传递给其他人，就像.torrent种子文件一样，其他人就能够根据文件中的信息还原出原文件了。